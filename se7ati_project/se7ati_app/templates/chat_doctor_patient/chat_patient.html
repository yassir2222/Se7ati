
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sehaty Chat - Diabetes Support</title>
    <!-- Link to your compiled Tailwind CSS file or use the CDN for testing -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <style>
        /* Optional: Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen antialiased text-gray-800">
        <div class="flex flex-row h-full w-full overflow-x-hidden">

            <!-- Sidebar -->
            <div class="flex flex-col py-8 pl-6 pr-2 w-64 bg-white flex-shrink-0 border-r border-gray-200">
                <!-- Logo/Header -->
                <div class="flex flex-row items-center justify-center h-12 w-full">
                    
                    <div class="ml-2 font-bold text-xl text-indigo-700 w-20"><a  href="{% url 'home' %}"> <img src="{% static 'images/logo.png' %}"> </a></div>
                </div>

                <!-- User Profile (Optional) -->
                <div class="flex flex-col items-center bg-indigo-100 border border-gray-200 mt-4 w-full py-6 px-4 rounded-lg">
                    <div class="h-20 w-20 rounded-full border overflow-hidden">
                        <img src="https://via.placeholder.com/150/771796" alt="My Profile" class="h-full w-full" /> <!-- Replace with actual user image -->
                    </div>
                    <div class="text-sm font-semibold mt-2 text-gray-800">Your Name</div> <!-- Replace with actual user name -->
                    <div class="text-xs text-gray-500">Patient</div>
                </div>

                <!-- Active Conversations -->
                <div class="flex flex-col mt-8">
                    <div class="flex flex-row items-center justify-between text-xs">
                        <span class="font-semibold text-gray-600">Active Conversations</span>
                        <span class="flex items-center justify-center bg-gray-300 h-4 w-4 rounded-full text-gray-700 font-medium">3</span> <!-- Example count -->
                    </div>
                    <div class="flex flex-col space-y-1 mt-4 -mx-2 h-full overflow-y-auto pr-2">
                        <!-- Active Chat Item -->
                        <button class="flex flex-row items-center hover:bg-gray-100 rounded-xl p-2 bg-blue-100 border-l-4 border-blue-500">
                            <div class="flex items-center justify-center h-8 w-8 bg-indigo-200 rounded-full">D</div> <!-- Initials or Avatar -->
                            <div class="ml-2 text-sm font-semibold text-gray-800">Dr. Aisha Khan</div>
                        </button>
                        <!-- Inactive Chat Item -->
                        <button class="flex flex-row items-center hover:bg-gray-100 rounded-xl p-2">
                            <div class="flex items-center justify-center h-8 w-8 bg-gray-200 rounded-full">S</div>
                            <div class="ml-2 text-sm font-semibold text-gray-700">Support Group</div>
                            <span class="flex items-center justify-center ml-auto text-xs text-white bg-red-500 h-4 w-4 rounded leading-none">2</span> <!-- New Message Count -->
                        </button>
                         <!-- Inactive Chat Item -->
                        <button class="flex flex-row items-center hover:bg-gray-100 rounded-xl p-2">
                            <div class="flex items-center justify-center h-8 w-8 bg-orange-200 rounded-full">N</div>
                            <div class="ml-2 text-sm font-semibold text-gray-700">Nutritionist Ali</div>
                        </button>
                        <!-- Add more conversation buttons here -->
                    </div>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="flex flex-col flex-auto h-full p-0 md:p-6">
                <div class="flex flex-col flex-auto flex-shrink-0 rounded-2xl bg-white h-full p-4 shadow-lg">

                    <!-- Chat Header -->
                    <div class="flex items-center justify-between py-3 border-b-2 border-gray-200">
                        <div class="flex items-center space-x-4">
                             <div class="flex items-center justify-center h-10 w-10 rounded-full bg-indigo-500 text-white font-bold flex-shrink-0">
                                D <!-- Placeholder for Dr. Aisha Khan -->
                             </div>
                            <div class="flex flex-col leading-tight">
                                <div class="text-lg mt-1 flex items-center">
                                    <span class="text-gray-700 mr-3 font-semibold">{{room_details.doctor_room }}</span>
                                    <span class="text-gray-700 mr-3 font-semibold color">{{room_details.id}}</span>
                                </div>
                               
                                <span class="text-sm text-green-500">Online</span> <!-- Or 'Offline', 'Last seen...' -->
                            </div>
                        </div>
                         <!-- Header Actions (Optional) -->
                        <div class="flex items-center space-x-2">
                            <button type="button" class="inline-flex items-center justify-center rounded-lg border h-10 w-10 transition duration-200 ease-in-out text-gray-500 hover:bg-gray-100 focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z" />
                                </svg>
                            </button>
                            <button type="button" class="inline-flex items-center justify-center rounded-lg border h-10 w-10 transition duration-200 ease-in-out text-gray-500 hover:bg-gray-100 focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Message History -->
                    <div id="messages" class="flex flex-col space-y-4 p-3 overflow-y-auto flex-grow scrollbar-thumb-blue scrollbar-thumb-rounded scrollbar-track-blue-lighter scrollbar-w-2 scrolling-touch">

                        <!-- Received Message Example -->
                        <div class="chat-message">
                            <div class="flex items-end">
                                <div class="flex flex-col space-y-2 text-sm max-w-xs mx-2 order-2 items-start">
                                    <div>
                                        <span class="px-4 py-2 rounded-lg inline-block rounded-bl-none bg-gray-200 text-gray-700 shadow-sm">
                                            Hello! How have your blood sugar levels been this morning? Remember to take your readings before breakfast.
                                        </span>
                                    </div>
                                    <span class="text-xs text-gray-500 leading-none">10:30 AM</span>
                                </div>
                                <div class="flex items-center justify-center h-8 w-8 rounded-full bg-indigo-500 text-white font-bold order-1 flex-shrink-0">D</div>
                            </div>
                        </div>

                        <!-- Sent Message Example -->
                        <div class="chat-message">
                            <div class="flex items-end justify-end">
                                <div class="flex flex-col space-y-2 text-sm max-w-xs mx-2 order-1 items-end">
                                    <div>
                                        <span class="px-4 py-2 rounded-lg inline-block rounded-br-none bg-blue-500 text-white shadow-sm">
                                            Good morning, Dr. Aisha. Levels were 110 mg/dL this morning before breakfast. Feeling good today!
                                        </span>
                                     </div>
                                    <span class="text-xs text-blue-200 leading-none">10:32 AM</span>
                                </div>
                                <div class="flex items-center justify-center h-8 w-8 rounded-full bg-blue-500 text-white font-bold order-2 flex-shrink-0">Y</div> <!-- Placeholder for 'You' -->
                            </div>
                        </div>

                         <!-- Sent File Message Example -->
                         <div class="chat-message">
                            <div class="flex items-end justify-end">
                                <div class="flex flex-col space-y-2 text-sm max-w-xs mx-2 order-1 items-end">
                                    <div>
                                        <span class="px-4 py-2 rounded-lg inline-block rounded-br-none bg-blue-500 text-white shadow-sm">
                                            <a href="/path/to/your/blood_sugar_log.pdf" target="_blank" class="flex items-center underline hover:text-blue-100">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1 flex-shrink-0">
                                                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                                                </svg>
                                                blood_sugar_log.pdf
                                            </a>
                                        </span>
                                     </div>
                                    <span class="text-xs text-blue-200 leading-none">10:35 AM</span>
                                </div>
                                <div class="flex items-center justify-center h-8 w-8 rounded-full bg-blue-500 text-white font-bold order-2 flex-shrink-0">Y</div> <!-- Placeholder for 'You' -->
                            </div>
                        </div>

                        <!-- Add more message blocks here -->

                    </div>
<form id="post-form" methode = "POST">
    {% csrf_token %}
    <div class="border-t-2 border-gray-200 px-4 pt-4 mb-2 sm:mb-0">
        <div class="relative flex">
            <input type="hidden" name="username" id="username" value="{{username}}"/>
            <input type="hidden" name="room_id" id="room_id" value="{{room_details.id}}"/>
            <!-- Attach Button -->
             <span class="absolute left-0 top-0 bottom-0 flex items-center pl-2">
                <button type="button" class="inline-flex items-center justify-center rounded-full h-10 w-10 transition duration-200 ease-in-out text-gray-500 hover:bg-gray-100 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6 text-gray-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.122 2.122l7.81-7.81"/>
                    </svg>
                </button>
            </span>

            <!-- Text Input -->
            <input type="text" id="message" placeholder="Write your message!" class="w-full focus:outline-none focus:placeholder-gray-400 text-gray-600 placeholder-gray-400 pl-12 bg-gray-100 border border-gray-200 rounded-lg py-3 focus:ring-2 focus:ring-blue-300 focus:border-transparent" />

             <!-- Send Button -->
            <div class="absolute right-0 top-0 bottom-0 flex items-center pr-2">
                <button type="submit" class="inline-flex items-center justify-center rounded-lg px-4 py-2 transition duration-200 ease-in-out text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-1">
                    <span class="font-semibold hidden sm:inline">Send</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5 ml-0 sm:ml-1 transform rotate-45">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </div>
        </div>
    </div> 

</form>
                    <!-- Input Area -->
                    <!-- End Input Area -->

                </div> <!-- End Chat Area Container -->
            </div> <!-- End Main Chat Area -->

        </div> <!-- End Flex Row -->
    </div> <!-- End Screen Container -->
    <script type="text/javascript">
        // Ensure jQuery is loaded before this script runs
        $(document).ready(function() { // Optional: Wrap in document ready
    
            $(document).on('submit', '#post-form', function(e) {
                e.preventDefault(); // Prevent default page reload
    
                var messageValue = $('#message').val().trim();
                var roomIdValue = $('#room_id').val(); 
                var csrfTokenValue = $('input[name=csrfmiddlewaretoken]').val();

                if (!messageValue) {
                    alert('Please enter a message.');
                    return;
                }
                if (!roomIdValue) {
                    alert('Error: Room ID is missing. Cannot send message.');
                    console.error("Room ID input (#room_id) is missing or empty.");
                    return;
                }
                 if (!csrfTokenValue) {
                    alert('Error: Security token is missing. Cannot send message.');
                    console.error("CSRF token input is missing.");
                    return;
                }
    
                console.log("Sending message:", messageValue, "to room ID:", roomIdValue); 
    
                $.ajax({
                    type: 'POST',
                    url: "{% url 'send_message' %}", 
                    data: {
                        room_id: roomIdValue,
                        message: messageValue,
                        csrfmiddlewaretoken: csrfTokenValue,
                    },
                    dataType: 'json', 
                    success: function(data) {

                        console.log("Server Success Response:", data);
    

                        if (data.status === 'success') {

                            console.log("Success:", data.message);

                            $('#message').val('');
                        } else {

                            console.error("Server reported error:", data.message);
                            alert("Error: " + data.message);
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
 
                        console.error("AJAX Error:", textStatus, errorThrown);
                        console.error("Response Text:", jqXHR.responseText);
    
                        let errorMsg = "Failed to send message. ";
                        if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                             errorMsg += jqXHR.responseJSON.message; 
                        } else if (jqXHR.status === 403) {
                            errorMsg += "Authorization failed (check login/CSRF).";
                        } else if (jqXHR.status === 404) {
                            errorMsg += "Chat room not found.";
                        } else {
                            errorMsg += "Please check your connection or try again later.";
                        }
                         alert(errorMsg);
   
                    }
                });
            });
    
        });
    </script>


<script>
        $(document).ready(function(){
          var display = $("#display");
          // Get the URL dynamically using Django's url tag
          var getMessagesUrl = "{% url 'get_message' room_name=room_details.name %}"; // <-- Use url tag
  
          setInterval(function(){
              $.ajax({
                  type: 'GET',
                  url : getMessagesUrl, // <--- Use the generated URL variable
                  success: function(response){
                      console.log("Received messages:", response); // Log the response
                      if (response && response.messages) { // Check if response and messages exist
                          var isAtBottom = display.scrollTop() + display.innerHeight() >= display[0].scrollHeight - 10; // Add tolerance
                          $("#display").empty(); // Clear previous messages
  
                          // Determine current user's username for styling
                          var currentUsername = "{{ request.user.username }}"; // Get current user from Django
  
                          for (var key in response.messages)
                          {
                              var messageData = response.messages[key];
                              var rawDate = new Date(messageData.date); // Date is already ISO format
                              var formattedDate = rawDate.toLocaleString('fr-FR', { /*day: 'numeric', month: 'short', year: 'numeric',*/ hour: '2-digit', minute:'2-digit'}); // Simpler format
  
                              // Add classes for styling based on sender
                              var messageClass = 'message-container '; // Base class
                              var bubbleClass = 'message-bubble ';
                              var alignmentClass = 'items-start'; // Default: received (left)
                              var bubbleBgColor = 'bg-gray-200 text-gray-800'; // Received bubble
                              var roundedCorner = 'rounded-bl-none'; // Received bubble corner
  
                              if (messageData.user === currentUsername) {
                                  // Message sent by the current user
                                  alignmentClass = 'items-end justify-end'; // Sent (right)
                                  bubbleBgColor = 'bg-blue-500 text-white'; // Sent bubble
                                  roundedCorner = 'rounded-br-none'; // Sent bubble corner
                                  messageClass += ' sent'; // Add specific class if needed
                              } else {
                                  messageClass += ' received'; // Add specific class if needed
                              }
  
                              // Build message HTML using Tailwind concepts (adjust classes as needed)
                              var temp =`
                                  <div class="flex ${alignmentClass} ${messageClass}">
                                      <div class="flex flex-col space-y-1 text-sm max-w-xs mx-2 ${messageData.user === currentUsername ? 'order-1 items-end' : 'order-2 items-start'}">
                                          <div>
                                              <span class="px-3 py-2 rounded-lg inline-block ${roundedCorner} ${bubbleBgColor} ${bubbleClass}">
                                                  ${messageData.value}
                                              </span>
                                          </div>
                                          <span class="text-xs text-gray-500 leading-none">${messageData.user} - ${formattedDate}</span>
                                      </div>
                                      <!-- Optional Avatar Placeholder
                                      <div class="w-6 h-6 rounded-full ${messageData.user === currentUsername ? 'order-2 bg-blue-500' : 'order-1 bg-pink-500'} text-white flex items-center justify-center text-xs font-bold flex-shrink-0">
                                          ${messageData.user.charAt(0).toUpperCase()}
                                      </div>
                                      -->
                                  </div>`;
  
                              $("#display").append(temp);
                          }
  
                          // Scroll logic
                          if (isAtBottom) {
                              // Use setTimeout to ensure DOM is updated before scrolling
                              setTimeout(function() {
                                  display.scrollTop(display[0].scrollHeight);
                              }, 0);
                          }
                      } else {
                          console.error("Invalid response format received:", response);
                      }
                  },
                  error: function(jqXHR, textStatus, errorThrown){
                      console.error("AJAX Error fetching messages:", textStatus, errorThrown);
                      // Optionally display an error message to the user in the chat window
                      // $("#display").append("<div class='text-red-500 text-center text-sm'>Error loading messages.</div>");
                  }
              });
          }, 1500); // Increased interval slightly
      });
      </script> 
</body>
</html>